<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bazinga Class Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }
        .toggle-checkbox { transition: transform 0.2s ease-in-out; }
        .toggle-checkbox:checked { transform: translateX(calc(100% - 2px)); border-color: #4f46e5; }
        .toggle-checkbox:checked + .toggle-label { background-color: #4f46e5; }
        .modal-backdrop { -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
        .notification-badge { line-height: 1; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 h-full flex items-center justify-center p-4 transition-colors duration-300">

    <div id="loading-spinner" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center z-[100]"><div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-indigo-500"></div></div>
    
    <div id="auth-container" class="w-full max-w-md hidden">
        <div class="bg-white dark:bg-slate-800/50 dark:backdrop-blur-lg border border-slate-200 dark:border-slate-700 p-8 rounded-2xl shadow-2xl">
            <h2 class="text-3xl font-bold text-center text-slate-800 dark:text-white mb-2">Welcome!</h2>
            <p class="text-center text-slate-500 dark:text-slate-400 mb-8">Sign in to the Bazinga Class Chat</p>
            <div id="auth-error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6 hidden" role="alert"><strong class="font-bold">Error:</strong><span class="block sm:inline" id="auth-error-message"></span></div>
            <form id="email-form" class="space-y-4">
                <input type="email" id="email-input" placeholder="Email address" required class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition duration-200">
                <input type="password" id="password-input" placeholder="Password" required class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition duration-200">
                <div class="flex flex-col sm:flex-row gap-2">
                    <button type="button" id="login-button" class="w-full bg-indigo-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all duration-200 transform active:scale-95">Login</button>
                    <button type="button" id="signup-button" class="w-full bg-slate-600 text-white font-semibold py-3 px-5 rounded-lg hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all duration-200 transform active:scale-95">Sign Up</button>
                </div>
            </form>
            <div class="my-6 flex items-center"><div class="flex-grow border-t border-slate-300 dark:border-slate-700"></div><span class="flex-shrink mx-4 text-xs font-medium text-slate-400 dark:text-slate-500">OR</span><div class="flex-grow border-t border-slate-300 dark:border-slate-700"></div></div>
             <div class="space-y-3">
                <button id="google-signin-button" class="w-full flex items-center justify-center gap-3 bg-white dark:bg-slate-700/50 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white font-semibold py-3 px-5 rounded-lg hover:bg-slate-50 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition"><svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12s5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.617-3.276-11.283-7.942l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571l6.19,5.238C42.022,35.244,44,30.036,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>Sign in with Google</button>
                 <button id="download-zip-button" class="w-full flex items-center justify-center gap-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 text-slate-700 dark:text-white font-semibold py-3 px-5 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>Download Source</button>
            </div>
        </div>
    </div>

    <div id="main-app-container" class="flex h-full max-h-[95vh] w-full max-w-5xl bg-white dark:bg-slate-800/80 dark:backdrop-blur-lg rounded-2xl shadow-2xl hidden border border-slate-200 dark:border-slate-700">
        <aside class="w-[280px] border-r border-slate-200 dark:border-slate-700 flex flex-col bg-slate-50 dark:bg-slate-800/50 rounded-l-2xl">
            <header class="p-4 border-b border-slate-200 dark:border-slate-700 flex items-center justify-between">
                <h2 class="text-lg font-bold text-slate-800 dark:text-white">Conversations</h2>
                <button id="inbox-button" class="relative p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    <span id="notification-badge" class="absolute top-0 right-0 block h-4 w-4 rounded-full bg-red-500 text-white text-xs text-center notification-badge hidden"></span>
                </button>
            </header>
            <div id="chats-list-container" class="flex-1 p-2 overflow-y-auto custom-scrollbar"></div>
            <div id="sidebar-footer" class="p-2 space-y-1 border-t border-slate-200 dark:border-slate-700">
                <button id="create-group-button" class="w-full text-left p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center gap-3"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7.5" r="4.5"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="17" y1="11" x2="23" y2="11"></line></svg><p class="font-semibold text-slate-800 dark:text-white">Create Group</p></button>
                <button id="admin-panel-button" class="w-full text-left p-2 rounded-md hover:bg-slate-200 dark:hover:bg-slate-700 transition flex items-center gap-3 hidden"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg><p class="font-semibold text-slate-800 dark:text-white">Admin Panel</p></button>
            </div>
        </aside>

        <div id="chat-container" class="flex-1 flex flex-col bg-slate-100 dark:bg-slate-800 rounded-r-2xl">
            <header class="p-4 border-b border-slate-200 dark:border-slate-700 flex justify-between items-center bg-white dark:bg-slate-800/50 rounded-tr-2xl">
                <div>
                    <h1 id="chat-title" class="text-xl font-bold text-slate-800 dark:text-white"></h1>
                    <p id="chat-subtitle" class="text-xs text-slate-500 dark:text-slate-400 mt-1 truncate"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="settings-button" title="Settings" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06-.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
                    <button id="signout-button" title="Sign Out" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600 dark:text-slate-300"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg></button>
                </div>
            </header>
            <div id="motd-container" class="p-2 border-b border-slate-200 dark:border-slate-700 hidden"></div>
            <main id="messages-container" class="flex-1 p-6 overflow-y-auto custom-scrollbar"></main>
            <footer class="relative p-4 bg-white dark:bg-slate-800/50">
                <div id="mention-suggestions" class="absolute bottom-full left-4 right-4 mb-1 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-lg max-h-40 overflow-y-auto custom-scrollbar hidden"></div>
                <div id="mute-indicator" class="text-center text-sm text-red-500 mb-2 hidden">You are muted and cannot send messages.</div>
                <div id="chat-lock-indicator" class="text-center text-sm text-yellow-500 mb-2 hidden">Public chat is temporarily locked by an administrator.</div>
                <form id="message-form" class="flex items-center space-x-3"><input type="text" id="message-input" placeholder="Type a message..." autocomplete="off" required class="flex-1 p-3 bg-slate-100 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition duration-200"><button type="submit" class="bg-indigo-600 text-white font-semibold p-3 rounded-full hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 dark:focus:ring-offset-slate-800 transition-all duration-200 transform active:scale-90"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form>
            </footer>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="it-warning-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[70] hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md text-center space-y-4 border border-slate-200 dark:border-slate-700"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-yellow-500"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" x2="12" y1="9" y2="13"></line><line x1="12" x2="12.01" y1="17" y2="17"></line></svg><h2 class="text-xl font-bold text-slate-800 dark:text-white">A message from I.T. Support</h2><p class="text-slate-600 dark:text-slate-300">This chat is monitored. Please be respectful. Inappropriate language may result in account suspension or loss of computer privileges.</p><button id="warning-understood-button" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">I Understand</button></div></div>
    <div id="suspended-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[80] hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md text-center space-y-4 border border-slate-200 dark:border-slate-700"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-red-500"><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></svg><h2 class="text-xl font-bold text-slate-800 dark:text-white">Account Suspended</h2><p id="suspension-message" class="text-slate-600 dark:text-slate-300"></p><p class="text-sm text-slate-400 mt-4">You will be logged out automatically.</p></div></div>
    <div id="maintenance-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[90] hidden"><div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md text-center space-y-4 border border-slate-200 dark:border-slate-700"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto text-blue-500"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg><h2 class="text-xl font-bold text-slate-800 dark:text-white">Under Maintenance</h2><p class="text-slate-600 dark:text-slate-300">The chat is currently down for maintenance. Please check back later.</p></div></div>
    <div id="inbox-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>
    <div id="settings-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>
    <div id="user-profile-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>
    <div id="admin-panel-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-50 hidden"></div>
    <div id="admin-edit-user-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[60] hidden"></div>
    <div id="admin-suspend-user-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[60] hidden"></div>
    <div id="create-group-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[60] hidden"></div>
    <div id="update-log-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[60] hidden"></div>
    <div id="confirmation-modal" class="fixed inset-0 bg-slate-900/50 modal-backdrop flex items-center justify-center z-[60] hidden"></div>

    <script type="text/template" id="create-group-modal-template">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md space-y-4 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Create Group Chat</h2>
                <button id="create-group-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button>
            </div>
            <form id="create-group-form" class="space-y-4">
                <div>
                    <label for="group-name-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Group Name</label>
                    <input type="text" id="group-name-input" required class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Add Friends</label>
                    <div id="group-friends-list" class="max-h-48 overflow-y-auto space-y-2 p-2 border border-slate-200 dark:border-slate-600 rounded-lg custom-scrollbar"></div>
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" id="create-group-discard" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Discard</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Create</button>
                </div>
            </form>
        </div>
    </script>
    
    <script type="text/template" id="inbox-modal-template">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md space-y-4 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center"><h2 class="text-2xl font-bold text-slate-800 dark:text-white">Inbox</h2><button id="inbox-modal-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button></div>
            <div id="inbox-content" class="space-y-3 max-h-96 overflow-y-auto custom-scrollbar"></div>
        </div>
    </script>
    
    <script type="text/template" id="admin-suspend-user-modal-template">
         <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md space-y-4 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Suspend User</h2>
                <button id="admin-suspend-user-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button>
            </div>
            <form id="admin-suspend-form" class="space-y-4">
                <input type="hidden" id="admin-suspend-uid">
                <div>
                    <label for="admin-suspend-duration" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Duration</label>
                    <div class="flex gap-2">
                        <input type="number" id="admin-suspend-duration-value" min="1" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                        <select id="admin-suspend-duration-unit" class="p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                            <option value="minutes">Minutes</option>
                            <option value="hours">Hours</option>
                            <option value="days">Days</option>
                        </select>
                    </div>
                </div>
                 <div class="flex items-center justify-between">
                    <label for="admin-suspend-permanent-toggle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Permanent Suspension</label>
                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full">
                        <input type="checkbox" id="admin-suspend-permanent-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/>
                        <label for="admin-suspend-permanent-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                    </div>
                </div>
                 <div>
                    <label for="admin-suspend-reason" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Reason (optional)</label>
                    <textarea id="admin-suspend-reason" rows="3" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition"></textarea>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Apply Suspension</button>
                </div>
            </form>
        </div>
    </script>
    
    <script type="text/template" id="admin-edit-user-modal-template">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md space-y-4 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-between items-center">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Edit User</h2>
                <button id="admin-edit-user-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button>
            </div>
            <form id="admin-edit-form" class="space-y-4">
                <input type="hidden" id="admin-edit-uid">
                <div>
                    <label for="admin-edit-username" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Username</label>
                    <input type="text" id="admin-edit-username" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                </div>
                <div class="flex items-center justify-between">
                    <label for="admin-edit-isadmin-toggle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Administrator</label>
                    <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full">
                        <input type="checkbox" id="admin-edit-isadmin-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/>
                        <label for="admin-edit-isadmin-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label>
                    </div>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </script>

    <script type="text/template" id="admin-panel-modal-template">
        <div class="bg-white dark:bg-slate-800 flex flex-col w-full max-w-4xl rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Admin Panel</h2>
                <button id="admin-modal-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button>
            </div>
            <div class="flex-1 flex overflow-y-hidden">
                <nav class="w-48 p-4 border-r border-slate-200 dark:border-slate-700">
                    <ul class="space-y-1" id="admin-nav">
                        <li><button data-panel="dashboard" class="admin-nav-button w-full text-left p-2 rounded-md font-semibold bg-indigo-100 text-indigo-700 dark:bg-indigo-500/20 dark:text-indigo-300">Dashboard</button></li>
                        <li><button data-panel="users" class="admin-nav-button w-full text-left p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">Users</button></li>
                        <li><button data-panel="reports" class="admin-nav-button w-full text-left p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 relative">Reports <span id="reports-badge" class="absolute top-1 right-1 block h-4 w-4 rounded-full bg-red-500 text-white text-xs text-center notification-badge hidden"></span></button></li>
                        <li><button data-panel="system" class="admin-nav-button w-full text-left p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700">System</button></li>
                    </ul>
                </nav>
                <div class="flex-1 overflow-y-auto" id="admin-content-area">
                    <!-- Dashboard -->
                    <div id="admin-panel-dashboard" class="p-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg"><h3 class="font-semibold">Total Users</h3><p id="stats-total-users" class="text-2xl font-bold">0</p></div>
                            <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg"><h3 class="font-semibold">Online (5m)</h3><p id="stats-online-users" class="text-2xl font-bold">0</p></div>
                            <div class="p-4 bg-slate-100 dark:bg-slate-700 rounded-lg"><h3 class="font-semibold">Public Msgs (24h)</h3><p id="stats-public-msgs" class="text-2xl font-bold">0</p></div>
                        </div>
                         <form id="broadcast-form" class="flex items-center gap-2 pt-4">
                             <input type="text" id="broadcast-input" placeholder="Send an announcement to public chat..." class="flex-1 p-2 bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                             <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Broadcast</button>
                         </form>
                    </div>
                    <!-- Users -->
                    <div id="admin-panel-users" class="hidden">
                        <div class="p-4 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-white dark:bg-slate-800">
                             <input type="search" id="admin-user-search" placeholder="Search by username..." class="w-full p-2 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition">
                        </div>
                        <div id="admin-user-list" class="p-6 space-y-2"></div>
                    </div>
                    <!-- Reports -->
                    <div id="admin-panel-reports" class="p-6 hidden">
                        <h3 class="text-xl font-bold mb-4">Reported Messages</h3>
                        <div id="admin-reports-list" class="space-y-2"></div>
                    </div>
                    <!-- System -->
                    <div id="admin-panel-system" class="p-6 space-y-6 hidden">
                         <div>
                            <h3 class="text-lg font-bold mb-2">System Controls</h3>
                            <div class="space-y-2">
                                <div class="flex items-center justify-between"><label for="maintenance-toggle" class="text-sm font-medium">Maintenance Mode</label><div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full"><input type="checkbox" id="maintenance-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/><label for="maintenance-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label></div></div>
                                <div class="flex items-center justify-between"><label for="chat-lock-toggle" class="text-sm font-medium">Lock Public Chat</label><div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full"><input type="checkbox" id="chat-lock-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/><label for="chat-lock-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label></div></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-2">Message of the Day</h3>
                            <form id="motd-form" class="flex items-center gap-2">
                                <input type="text" id="motd-input" placeholder="Set a MOTD for public chat..." class="flex-1 p-2 bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg">
                                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Set</button>
                                <button type="button" id="clear-motd-button" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600">Clear</button>
                            </form>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-2">Banned Words Filter</h3>
                             <form id="banned-words-form" class="space-y-2">
                                <textarea id="banned-words-input" rows="4" class="w-full p-2 bg-slate-100 dark:bg-slate-900 border border-slate-300 dark:border-slate-600 rounded-lg" placeholder="Enter comma-separated words"></textarea>
                                <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Save Filter</button>
                            </form>
                        </div>
                         <div>
                            <h3 class="text-lg font-bold mb-2">Actions</h3>
                            <button id="clear-chat-button" class="w-full bg-amber-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-amber-600 transition">Clear Public Chat History</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script type="text/template" id="settings-modal-template">
        <div class="bg-white dark:bg-slate-800 flex flex-col w-full max-w-md rounded-2xl shadow-2xl border border-slate-200 dark:border-slate-700 max-h-[90vh]">
            <div class="flex justify-between items-center p-6 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-2xl font-bold text-slate-800 dark:text-white">Settings</h2>
                <button id="settings-modal-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
                <form id="settings-form" class="space-y-6">
                    <details open>
                        <summary class="font-semibold text-lg cursor-pointer text-slate-800 dark:text-white">Profile</summary>
                        <div class="space-y-4 pt-4">
                            <div><label for="username-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Display Name</label><input type="text" id="username-input" required class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition"></div>
                            <div><label for="status-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Status</label><input type="text" id="status-input" placeholder="What's on your mind?" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition"></div>
                            <div><label for="avatar-url-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Avatar URL</label><input type="url" id="avatar-url-input" placeholder="https://example.com/image.png" class="w-full p-3 bg-slate-100 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:text-white transition"></div>
                            <div class="text-center text-sm text-slate-500 dark:text-slate-400">OR</div>
                            <div><label for="avatar-upload-input" class="block text-sm font-medium text-slate-700 dark:text-slate-300 mb-2">Upload an Image</label><div class="flex items-center gap-4"><img id="avatar-preview" src="" class="w-12 h-12 rounded-full object-cover bg-slate-200 dark:bg-slate-600 hidden"><input type="file" id="avatar-upload-input" accept="image/png, image/jpeg" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/></div><div id="upload-progress-container" class="mt-2 hidden"><div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700"><div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div></div><p id="upload-progress-text" class="text-sm text-center text-slate-500 mt-1">Uploading...</p></div></div>
                        </div>
                    </details>
                     <div class="border-t border-slate-200 dark:border-slate-700"></div>
                     <details>
                        <summary class="font-semibold text-lg cursor-pointer text-slate-800 dark:text-white">Preferences</summary>
                         <div class="space-y-4 pt-4">
                            <div class="flex items-center justify-between"><label for="dark-mode-toggle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Dark Mode</label><div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full"><input type="checkbox" id="dark-mode-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/><label for="dark-mode-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label></div></div>
                            <div class="flex items-center justify-between"><label for="message-sounds-toggle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Message Sounds</label><div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full"><input type="checkbox" id="message-sounds-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/><label for="message-sounds-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label></div></div>
                            <div class="flex items-center justify-between"><label for="online-status-toggle" class="text-sm font-medium text-slate-700 dark:text-slate-300">Show Online Status</label><div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in bg-slate-300 dark:bg-slate-600 rounded-full"><input type="checkbox" id="online-status-toggle" class="toggle-checkbox absolute block w-5 h-5 m-0.5 rounded-full bg-white border-transparent appearance-none cursor-pointer"/><label for="online-status-toggle" class="toggle-label block overflow-hidden h-6 rounded-full cursor-pointer"></label></div></div>
                        </div>
                    </details>
                    <div class="border-t border-slate-200 dark:border-slate-700"></div>
                    <details>
                        <summary class="font-semibold text-lg cursor-pointer text-slate-800 dark:text-white">Account</summary>
                        <div class="space-y-4 pt-4">
                           <div class="flex items-center justify-between"><p class="text-sm font-medium text-slate-700 dark:text-slate-300">Email</p><p id="user-email-display" class="text-sm text-slate-500 dark:text-slate-400"></p></div>
                           <button type="button" id="password-reset-button" class="w-full text-sm bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Send Password Reset Email</button>
                           <button type="button" id="export-data-button" class="w-full text-sm bg-slate-200 text-slate-800 dark:bg-slate-600 dark:text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Export My Data (JSON)</button>
                        </div>
                    </details>
                    <div class="border-t border-slate-200 dark:border-slate-700"></div>
                     <details>
                        <summary class="font-semibold text-lg cursor-pointer text-slate-800 dark:text-white">Danger Zone</summary>
                         <div class="space-y-3 pt-4">
                           <button type="button" id="delete-account-button" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Delete My Account</button>
                        </div>
                    </details>
                </form>
            </div>
            <div class="p-6 border-t border-slate-200 dark:border-slate-700 flex justify-between items-center">
                 <button id="update-log-button" class="text-sm font-medium text-slate-600 hover:text-indigo-600 dark:text-slate-300 dark:hover:text-indigo-400 transition">Update Log</button>
                 <button type="submit" form="settings-form" id="save-profile-button" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Save Changes</button>
            </div>
        </div>
    </script>
    
    <script type="text/template" id="user-profile-modal-template">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-xs text-center space-y-4 border border-slate-200 dark:border-slate-700">
            <div class="flex justify-end"><button id="profile-modal-close" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button></div>
            <img id="profile-modal-avatar" src="" class="w-20 h-20 rounded-full mx-auto object-cover">
            <div class="relative">
                <h3 id="profile-modal-username" class="text-xl font-bold text-slate-800 dark:text-white"></h3>
                <span id="profile-modal-online-status" class="absolute top-0 -right-2 block h-3 w-3 rounded-full bg-green-500 hidden"></span>
            </div>
            <p id="profile-modal-status" class="text-sm text-slate-500 dark:text-slate-400 italic"></p>
            <div class="space-y-2 pt-2 border-t border-slate-200 dark:border-slate-700"><button id="friend-request-button" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Send Friend Request</button><button id="send-message-button" class="w-full bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-700 transition">Send Message</button><button id="block-user-button" class="w-full bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Block User</button><button id="unblock-user-button" class="w-full bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition hidden">Unblock User</button></div>
        </div>
    </script>

    <script type="text/template" id="update-log-modal-template">
        <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-md border border-slate-200 dark:border-slate-700"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800 dark:text-white">What's New?</h2><button id="update-log-close-button" class="p-1 text-2xl leading-none rounded-full hover:bg-slate-200 dark:hover:bg-slate-600 transition">&times;</button></div><div class="text-slate-600 dark:text-slate-300 space-y-4 prose prose-sm dark:prose-invert max-w-none"><p class="font-semibold">Welcome to the Bazinga Class Chat!</p><ul class="list-disc list-inside space-y-2"><li><span class="font-semibold">Chat Stability:</span> We've rolled out major fixes to improve chat stability and reliability.</li><li><span class="font-semibold">How to Add Friends:</span> To add a classmate, just tap on their profile picture in the public chat. If they've already friended you, friend them back to start a private message!</li><li><span class="font-semibold">Link Sharing:</span> Yes, you can send clickable links in messages!</li></ul><p class="text-xs pt-4 border-t border-slate-200 dark:border-slate-600"><span class="font-bold">A quick reminder:</span> Please be respectful. This chat is actively monitored to ensure a secure and respectful environment for everyone.</p></div></div>
    </script>

    <script type="text/template" id="confirmation-modal-template">
         <div class="bg-white dark:bg-slate-800 p-6 rounded-2xl shadow-2xl w-full max-w-sm border border-slate-200 dark:border-slate-700"><h2 id="confirmation-title" class="text-xl font-bold text-slate-800 dark:text-white mb-4">Are you sure?</h2><p id="confirmation-message" class="text-slate-600 dark:text-slate-300 mb-6"></p><div class="flex justify-end gap-3"><button id="confirm-cancel-button" class="bg-slate-200 dark:bg-slate-600 text-slate-800 dark:text-white font-semibold py-2 px-4 rounded-lg hover:bg-slate-300 dark:hover:bg-slate-500 transition">Cancel</button><button id="confirm-action-button" class="bg-red-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-700 transition">Confirm</button></div></div>
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, deleteUser, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, getDoc, getDocs, deleteDoc, updateDoc, arrayUnion, arrayRemove, query, where, onSnapshot, serverTimestamp, writeBatch, orderBy, limit, Timestamp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-storage.js";

        const firebaseConfig = { apiKey: "YOUR_KEY_HERE", authDomain: "PASTE_HERE.firebaseapp.com", databaseURL: "https://fir-chat-app-da3f3-default-rtdb.firebaseio.com", projectId: "PROJECT_ID", storageBucket: "fir-chat-app-da3f3.firebasestorage.app", messagingSenderId: "SENDER_ID", appId: "YOUR_APP_AND_WEB_KEY", measurementId: "G-T05NRKLEPN" };
        const appId = firebaseConfig.projectId;
        const adminEmails = ["EMAIL_1", "EMAIL_2", "EMAIL_3"];

        let db, auth, analytics, storage, audioContext;
        let currentUser = null, currentUserProfile = null, currentChatId = 'public';
        let messagesUnsubscribe = null, notificationsUnsubscribe = null, unreadChatsUnsubscribe = null, presenceInterval = null, allUsersForAdmin = [], systemConfigUnsubscribe = null;
        let usersCache = {}, profileModalTargetId = null, confirmationCallback = null;
        let unreadChats = new Set(), systemConfig = {};
        
        let loadingSpinner, authContainer, mainAppContainer, suspendedModal, maintenanceModal;

        const emojiMap = { "smile": "ðŸ˜„", "laugh": "ðŸ˜‚", "lol": "ðŸ˜‚", "heart": "â¤ï¸", "love": "ðŸ˜", "like": "ðŸ‘", "dislike": "ðŸ‘Ž", "wink": "ðŸ˜‰", "sad": "ðŸ˜¢", "cry": "ðŸ˜­", "cool": "ðŸ˜Ž", "nerd": "ðŸ¤“", "bazinga": "âš¡ï¸" };

        function main() {
            document.getElementById('inbox-modal').innerHTML = document.getElementById('inbox-modal-template').innerHTML;
            document.getElementById('settings-modal').innerHTML = document.getElementById('settings-modal-template').innerHTML;
            document.getElementById('user-profile-modal').innerHTML = document.getElementById('user-profile-modal-template').innerHTML;
            document.getElementById('update-log-modal').innerHTML = document.getElementById('update-log-modal-template').innerHTML;
            document.getElementById('confirmation-modal').innerHTML = document.getElementById('confirmation-modal-template').innerHTML;
            document.getElementById('admin-panel-modal').innerHTML = document.getElementById('admin-panel-modal-template').innerHTML;
            document.getElementById('admin-edit-user-modal').innerHTML = document.getElementById('admin-edit-user-modal-template').innerHTML;
            document.getElementById('admin-suspend-user-modal').innerHTML = document.getElementById('admin-suspend-user-modal-template').innerHTML;
            document.getElementById('create-group-modal').innerHTML = document.getElementById('create-group-modal-template').innerHTML;
            
            loadingSpinner = document.getElementById('loading-spinner');
            authContainer = document.getElementById('auth-container');
            mainAppContainer = document.getElementById('main-app-container');
            suspendedModal = document.getElementById('suspended-modal');
            maintenanceModal = document.getElementById('maintenance-modal');

            applyTheme(localStorage.getItem('theme') || 'light');
            try {
                const app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app); db = getFirestore(app); auth = getAuth(app); storage = getStorage(app);
                setupSystemConfigListener();
                setupAuthListener();
                setupEventListeners();
            } catch (error) { console.error("Firebase init failed:", error); loadingSpinner.style.display = 'none'; showAuthError("Could not connect."); }
        }
        
        function setupSystemConfigListener() {
            const configRef = doc(db, `/artifacts/${appId}/public/data/config/system`);
            systemConfigUnsubscribe = onSnapshot(configRef, (doc) => {
                systemConfig = doc.exists() ? doc.data() : {};
                
                const isPotentiallyAdmin = auth.currentUser && adminEmails.includes(auth.currentUser.email);

                document.getElementById('maintenance-modal').classList.toggle('hidden', !(systemConfig.maintenanceMode && !isPotentiallyAdmin));
                document.getElementById('chat-lock-indicator').classList.toggle('hidden', !systemConfig.chatLocked);

                const motdContainer = document.getElementById('motd-container');
                if (systemConfig.motd) {
                    motdContainer.innerHTML = `<p class="text-center text-sm font-medium text-indigo-800 dark:text-indigo-200">${systemConfig.motd}</p>`;
                    motdContainer.classList.remove('hidden');
                } else {
                    motdContainer.classList.add('hidden');
                }

                if (currentUserProfile?.isAdmin) {
                    document.getElementById('maintenance-toggle').checked = !!systemConfig.maintenanceMode;
                    document.getElementById('chat-lock-toggle').checked = !!systemConfig.chatLocked;
                    document.getElementById('motd-input').value = systemConfig.motd || '';
                    document.getElementById('banned-words-input').value = (systemConfig.bannedWords || []).join(', ');
                }
            });
        }

        function setupAuthListener() {
             onAuthStateChanged(auth, async (user) => {
                if (Object.keys(systemConfig).length === 0 && !systemConfigUnsubscribe) {
                    await new Promise(resolve => setTimeout(resolve, 350)); 
                }

                const isPotentiallyAdmin = user && adminEmails.includes(user.email);

                if (systemConfig.maintenanceMode && !isPotentiallyAdmin) {
                    showMaintenanceScreen();
                    if(user) await signOut(auth);
                    return;
                }

                if (user) {
                    currentUser = user; 
                    await fetchUserProfile(user.uid, true); 
                    currentUserProfile = usersCache[user.uid];
                    
                    if (!currentUserProfile) { 
                        const defaultUsername = user.email ? user.email.split('@')[0] : 'NewUser'; 
                        const defaultAvatar = user.photoURL || `https://placehold.co/100x100/e2e8f0/475569?text=${defaultUsername.charAt(0).toUpperCase()}`; 
                        const defaultProfile = { 
                            username: defaultUsername, 
                            avatarUrl: defaultAvatar, 
                            status: '', 
                            friends: [],
                            groups: [],
                            blocked: [], 
                            friendRequests: [], 
                            privateChatStatus: {}, 
                            suspended: false,
                            isAdmin: isPotentiallyAdmin,
                            muted: false,
                            prefs: { soundEnabled: true, showOnline: true }, 
                            lastSeen: serverTimestamp() 
                        };
                        await setDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid), defaultProfile); 
                        await fetchUserProfile(user.uid); 
                        currentUserProfile = usersCache[user.uid]; 
                    }

                    if (currentUserProfile.isAdmin !== isPotentiallyAdmin) {
                        await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid), { isAdmin: isPotentiallyAdmin });
                        currentUserProfile.isAdmin = isPotentiallyAdmin;
                    }

                    const suspensionStatus = currentUserProfile.suspended;
                    if (suspensionStatus) {
                        const suspensionMessage = document.getElementById('suspension-message');
                        let reason = currentUserProfile.suspensionReason ? ` Reason: ${currentUserProfile.suspensionReason}` : '';
                        if (suspensionStatus === true) {
                            suspensionMessage.textContent = 'Your account has been suspended indefinitely.' + reason;
                        } else if (suspensionStatus.toDate) {
                            const now = new Date();
                            const suspensionEnd = suspensionStatus.toDate();
                            if (now < suspensionEnd) {
                                const minutesLeft = Math.ceil((suspensionEnd - now) / (1000 * 60));
                                suspensionMessage.textContent = `Your account is temporarily suspended. Please wait ${minutesLeft} more minute(s).` + reason;
                            } else {
                                await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, user.uid), { suspended: false, suspensionReason: '' });
                                window.location.reload();
                                return;
                            }
                        }
                        suspendedModal.classList.remove('hidden');
                        loadingSpinner.style.display = 'none';

                        setTimeout(() => { signOut(auth); }, 4000); 
                        return;
                    }

                    document.getElementById('admin-panel-button').classList.toggle('hidden', !currentUserProfile.isAdmin);
                    document.getElementById('mute-indicator').classList.toggle('hidden', !currentUserProfile.muted);
                    showChatUI(); 
                    if (localStorage.getItem('itWarningSeen') !== 'true') document.getElementById('it-warning-modal').classList.remove('hidden');
                    renderChatsList(); 
                    switchToChat('public', 'Public Chat', 'public'); 
                    setupNotificationsListener(); 
                    setupUnreadChatsListener();
                    updatePresence();
                    if(presenceInterval) clearInterval(presenceInterval);
                    presenceInterval = setInterval(updatePresence, 60 * 1000);
                } else {
                    currentUser = null; currentUserProfile = null;
                    if (messagesUnsubscribe) messagesUnsubscribe(); 
                    if (notificationsUnsubscribe) notificationsUnsubscribe(); 
                    if(unreadChatsUnsubscribe) unreadChatsUnsubscribe(); 
                    if(presenceInterval) clearInterval(presenceInterval);
                    suspendedModal.classList.add('hidden');
                    if (systemConfig.maintenanceMode) {
                        showMaintenanceScreen();
                    } else {
                        showAuthUI();
                    }
                }
            });
        }
        
        function setupEventListeners() {
            document.getElementById('login-button').addEventListener('click', () => handleLogin(document.getElementById('email-input').value, document.getElementById('password-input').value));
            document.getElementById('signup-button').addEventListener('click', () => handleSignUp(document.getElementById('email-input').value, document.getElementById('password-input').value));
            document.getElementById('google-signin-button').addEventListener('click', handleGoogleSignIn);
            document.getElementById('signout-button').addEventListener('click', () => signOut(auth));
            document.getElementById('download-zip-button').addEventListener('click', () => downloadHtmlAsZip("bazinga-chat-source.zip"));
            document.getElementById('warning-understood-button').addEventListener('click', () => { document.getElementById('it-warning-modal').classList.add('hidden'); localStorage.setItem('itWarningSeen', 'true'); });
            document.getElementById('message-form').addEventListener('submit', (e) => { e.preventDefault(); sendMessage(document.getElementById('message-input').value); document.getElementById('message-input').value = ''; });
            document.getElementById('settings-button').addEventListener('click', () => { if (!currentUserProfile) return; document.getElementById('username-input').value = currentUserProfile.username || ''; document.getElementById('status-input').value = currentUserProfile.status || ''; document.getElementById('avatar-url-input').value = currentUserProfile.avatarUrl || ''; document.getElementById('user-email-display').textContent = currentUser.email; document.getElementById('message-sounds-toggle').checked = currentUserProfile.prefs?.soundEnabled ?? true; document.getElementById('online-status-toggle').checked = currentUserProfile.prefs?.showOnline ?? true; document.getElementById('settings-modal').classList.remove('hidden'); });
            document.getElementById('inbox-button').addEventListener('click', () => document.getElementById('inbox-modal').classList.remove('hidden'));
            document.getElementById('admin-panel-button').addEventListener('click', openAdminPanel);
            document.getElementById('create-group-button').addEventListener('click', openCreateGroupModal);
            
            document.body.addEventListener('click', async (e) => {
                const target = e.target.closest('button') || e.target;
                const targetId = target.id; 
                const notificationId = target.dataset.notificationId; 
                const senderId = target.dataset.senderId;
                const adminAction = target.dataset.adminAction;
                const adminTargetUid = target.dataset.uid;
                const adminPanel = target.dataset.panel;

                if (target.classList.contains('admin-nav-button')) {
                    document.querySelectorAll('.admin-nav-button').forEach(btn => btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-500/20', 'dark:text-indigo-300'));
                    target.classList.add('bg-indigo-100', 'text-indigo-700', 'dark:bg-indigo-500/20', 'dark:text-indigo-300');
                    document.querySelectorAll('#admin-content-area > div').forEach(div => div.classList.add('hidden'));
                    document.getElementById(`admin-panel-${adminPanel}`).classList.remove('hidden');
                }
                
                if (targetId === 'inbox-modal-close') document.getElementById('inbox-modal').classList.add('hidden'); 
                if (targetId === 'settings-modal-close') document.getElementById('settings-modal').classList.add('hidden'); 
                if (targetId === 'admin-modal-close') document.getElementById('admin-panel-modal').classList.add('hidden'); 
                if (targetId === 'admin-edit-user-close') document.getElementById('admin-edit-user-modal').classList.add('hidden');
                if (targetId === 'admin-suspend-user-close') document.getElementById('admin-suspend-user-modal').classList.add('hidden');
                if (targetId === 'create-group-close' || targetId === 'create-group-discard') document.getElementById('create-group-modal').classList.add('hidden');
                if (targetId === 'update-log-button') document.getElementById('update-log-modal').classList.remove('hidden'); 
                if (targetId === 'delete-account-button') showConfirmationModal('Delete Account', 'This is irreversible. Are you sure?', async () => { try { await deleteDoc(doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid)); await deleteUser(currentUser); document.getElementById('confirmation-modal').classList.add('hidden'); } catch (error) { console.error("Error deleting account:", error); alert("Failed to delete account."); document.getElementById('confirmation-modal').classList.add('hidden'); } }); 
                if (targetId === 'profile-modal-close') document.getElementById('user-profile-modal').classList.add('hidden'); 
                if (targetId === 'friend-request-button') sendFriendRequest(profileModalTargetId); 
                if (targetId === 'send-message-button') { const profile = await fetchUserProfile(profileModalTargetId); startPrivateChat(profileModalTargetId, profile.username); document.getElementById('user-profile-modal').classList.add('hidden'); } 
                if (targetId === 'block-user-button') blockUser(profileModalTargetId); 
                if (targetId === 'unblock-user-button') unblockUser(profileModalTargetId); 
                if (targetId === 'update-log-close-button') document.getElementById('update-log-modal').classList.add('hidden'); 
                if (targetId === 'confirm-cancel-button') document.getElementById('confirmation-modal').classList.add('hidden'); 
                if (targetId === 'confirm-action-button' && confirmationCallback) confirmationCallback(); 
                if (target.classList.contains('accept-friend-request')) acceptFriendRequest(senderId, notificationId); 
                if (target.classList.contains('decline-friend-request')) declineFriendRequest(notificationId);
                if (targetId === 'password-reset-button') { try { await sendPasswordResetEmail(auth, currentUser.email); alert('Password reset email sent!'); } catch (e) { alert('Failed to send reset email.'); } }
                if (targetId === 'export-data-button') downloadUserData();
                if (targetId === 'clear-motd-button') { await setDoc(doc(db, `/artifacts/${appId}/public/data/config/system`), { motd: '' }, { merge: true }); }
                if (target.dataset.action === 'delete-message') { showConfirmationModal('Delete Message', 'This will permanently delete this message for everyone. Are you sure?', () => deleteMessage(target.dataset.chatId, target.dataset.msgId));}
                if (target.dataset.action === 'report-message') { showConfirmationModal('Report Message', 'Are you sure you want to report this message to the administrators?', () => reportMessage(target.dataset.chatId, target.dataset.msgId, target.dataset.senderId));}
                if (target.dataset.action === 'resolve-report') { await updateDoc(doc(db, `/artifacts/${appId}/public/data/reports/${target.dataset.reportId}`), { resolved: true }); await loadAdminReports(); }

                if (adminAction && adminTargetUid) {
                    if (adminAction === 'edit-user') openAdminEditUserModal(adminTargetUid);
                    if (adminAction === 'suspend-user') openAdminSuspendModal(adminTargetUid);
                    if (adminAction === 'unban') { await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, adminTargetUid), { suspended: false, suspensionReason: '' }); await renderAdminUserList(); }
                    if (adminAction === 'toggle-mute') { const userToMute = allUsersForAdmin.find(u => u.uid === adminTargetUid); if(userToMute) await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, adminTargetUid), { muted: !userToMute.muted }); await renderAdminUserList(); }
                    if (adminAction === 'force-rename') { await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, adminTargetUid), { forceRename: true }); alert('User will be prompted to change their name on next login.');}
                    if (adminAction === 'impersonate') { alert('Impersonation mode is a demo feature. In a real app, this would require secure server-side logic to generate a custom auth token.'); }
                }
            });
            document.body.addEventListener('input', e => {
                if (e.target.id === 'admin-user-search') renderAdminUserList(e.target.value);
            });
            document.body.addEventListener('change', (e) => { 
                const targetId = e.target.id;
                const configRef = doc(db, `/artifacts/${appId}/public/data/config/system`);
                if (targetId === 'dark-mode-toggle') applyTheme(e.target.checked ? 'dark' : 'light');
                if (targetId === 'avatar-upload-input' && e.target.files[0]) { const reader = new FileReader(); reader.onload = (event) => { document.getElementById('avatar-preview').src = event.target.result; document.getElementById('avatar-preview').classList.remove('hidden'); }; reader.readAsDataURL(e.target.files[0]); } 
                if (targetId === 'admin-suspend-permanent-toggle') { document.getElementById('admin-suspend-duration-value').disabled = e.target.checked; document.getElementById('admin-suspend-duration-unit').disabled = e.target.checked; }
                if (targetId === 'maintenance-toggle') { setDoc(configRef, { maintenanceMode: e.target.checked }, { merge: true }); }
                if (targetId === 'chat-lock-toggle') { setDoc(configRef, { chatLocked: e.target.checked }, { merge: true }); }
            });
            document.body.addEventListener('submit', async (e) => { 
                if (e.target.id === 'settings-form') { 
                    e.preventDefault(); 
                    const newUsername = document.getElementById('username-input').value.trim();
                    const newStatus = document.getElementById('status-input').value.trim();
                    const soundEnabled = document.getElementById('message-sounds-toggle').checked;
                    const showOnline = document.getElementById('online-status-toggle').checked;
                    const newAvatarUrl = document.getElementById('avatar-url-input').value.trim(); 
                    const file = document.getElementById('avatar-upload-input').files[0]; 
                    if (!currentUser) return; 
                    const saveBtn = document.getElementById('save-profile-button'); 
                    saveBtn.disabled = true; saveBtn.textContent = 'Saving...'; 
                    const userRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid); 
                    const updatedProfileData = { username: newUsername, status: newStatus, 'prefs.soundEnabled': soundEnabled, 'prefs.showOnline': showOnline };
                    
                    const finalUpdate = async () => { 
                        await fetchUserProfile(currentUser.uid, true); 
                        currentUserProfile = usersCache[currentUser.uid]; 
                        document.getElementById('settings-modal').classList.add('hidden'); 
                        saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; 
                    }; 
                    
                    if (file) { 
                        const storageRef = ref(storage, `pfp/${currentUser.uid}/${file.name}`); 
                        const uploadTask = uploadBytesResumable(storageRef, file); 
                        document.getElementById('upload-progress-container').classList.remove('hidden'); 
                        uploadTask.on('state_changed', s => { const p = (s.bytesTransferred / s.totalBytes) * 100; document.getElementById('upload-progress-bar').style.width = p + '%'; document.getElementById('upload-progress-text').textContent = `Uploading... ${Math.round(p)}%`; }, e => { console.error(e); alert("Upload failed."); }, 
                        async () => { 
                            const url = await getDownloadURL(uploadTask.snapshot.ref); 
                            await updateDoc(userRef, { ...updatedProfileData, avatarUrl: url }); 
                            await finalUpdate(); 
                        }); 
                    } else { 
                        await updateDoc(userRef, { ...updatedProfileData, avatarUrl: newAvatarUrl }); 
                        await finalUpdate(); 
                    } 
                } 
                if (e.target.id === 'admin-edit-form') {
                    e.preventDefault();
                    const uid = document.getElementById('admin-edit-uid').value;
                    const newUsername = document.getElementById('admin-edit-username').value;
                    const isAdmin = document.getElementById('admin-edit-isadmin-toggle').checked;
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, uid), { username: newUsername, isAdmin: isAdmin });
                    document.getElementById('admin-edit-user-modal').classList.add('hidden');
                    await renderAdminUserList();
                }
                if (e.target.id === 'admin-suspend-form') {
                    e.preventDefault();
                    const uid = document.getElementById('admin-suspend-uid').value;
                    const reason = document.getElementById('admin-suspend-reason').value.trim();
                    const isPermanent = document.getElementById('admin-suspend-permanent-toggle').checked;
                    
                    let suspensionValue;
                    if (isPermanent) {
                        suspensionValue = true;
                    } else {
                        const durationValue = document.getElementById('admin-suspend-duration-value').value;
                        const durationUnit = document.getElementById('admin-suspend-duration-unit').value;
                        let multiplier = 1;
                        if (durationUnit === 'hours') multiplier = 60;
                        if (durationUnit === 'days') multiplier = 60 * 24;
                        const totalMinutes = durationValue * multiplier;
                        suspensionValue = Timestamp.fromMillis(Date.now() + totalMinutes * 60 * 1000);
                    }
                    
                    await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, uid), { suspended: suspensionValue, suspensionReason: reason });
                    document.getElementById('admin-suspend-user-modal').classList.add('hidden');
                    await renderAdminUserList();
                }
                if (e.target.id === 'broadcast-form') {
                    e.preventDefault();
                    const input = document.getElementById('broadcast-input');
                    const message = input.value.trim();
                    if (message) {
                        await addDoc(collection(db, `/artifacts/${appId}/public/data/messages`), {
                            text: message,
                            userId: currentUser.uid,
                            timestamp: serverTimestamp(),
                            type: 'broadcast'
                        });
                        input.value = '';
                    }
                }
                if (e.target.id === 'create-group-form') {
                    e.preventDefault();
                    const groupName = document.getElementById('group-name-input').value.trim();
                    const selectedFriends = Array.from(document.querySelectorAll('#group-friends-list input:checked')).map(input => input.value);
                    if (groupName && selectedFriends.length > 0) {
                        const members = [currentUser.uid, ...selectedFriends];
                        const groupRef = await addDoc(collection(db, `/artifacts/${appId}/public/data/groups`), {
                            name: groupName,
                            members: members,
                            createdBy: currentUser.uid,
                            createdAt: serverTimestamp()
                        });
                        // Add group to each member's profile
                        const batch = writeBatch(db);
                        members.forEach(memberId => {
                            const userRef = doc(db, `/artifacts/${appId}/public/data/users`, memberId);
                            batch.update(userRef, { groups: arrayUnion(groupRef.id) });
                        });
                        await batch.commit();
                        document.getElementById('create-group-modal').classList.add('hidden');
                        await renderChatsList();
                        switchToChat(`group_${groupRef.id}`, groupName, 'group');
                    }
                }
                 if (e.target.id === 'motd-form') {
                    e.preventDefault();
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/config/system`), { motd: document.getElementById('motd-input').value.trim() }, { merge: true });
                }
                if (e.target.id === 'banned-words-form') {
                    e.preventDefault();
                    const words = document.getElementById('banned-words-input').value.split(',').map(w => w.trim().toLowerCase()).filter(Boolean);
                    await setDoc(doc(db, `/artifacts/${appId}/public/data/config/system`), { bannedWords: words }, { merge: true });
                }
            });
        }
        
        async function openAdminPanel() {
            if (!currentUserProfile.isAdmin) return;
            document.getElementById('admin-panel-modal').classList.remove('hidden');
            document.querySelector('.admin-nav-button[data-panel="dashboard"]').click();
            await loadAdminDashboardStats();
            await renderAdminUserList();
            await loadAdminReports();
        }

        async function loadAdminDashboardStats() {
            const usersRef = collection(db, `/artifacts/${appId}/public/data/users`);
            const usersSnapshot = await getDocs(usersRef);
            document.getElementById('stats-total-users').textContent = usersSnapshot.size;

            const fiveMinutesAgo = Timestamp.fromMillis(Date.now() - 5 * 60 * 1000);
            const onlineQuery = query(usersRef, where('lastSeen', '>', fiveMinutesAgo));
            const onlineSnapshot = await getDocs(onlineQuery);
            document.getElementById('stats-online-users').textContent = onlineSnapshot.size;

            const twentyFourHoursAgo = Timestamp.fromMillis(Date.now() - 24 * 60 * 60 * 1000);
            const messagesRef = collection(db, `/artifacts/${appId}/public/data/messages`);
            const messagesQuery = query(messagesRef, where('timestamp', '>', twentyFourHoursAgo));
            const messagesSnapshot = await getDocs(messagesQuery);
            document.getElementById('stats-public-msgs').textContent = messagesSnapshot.size;
        }

        async function loadAdminReports() {
            const reportsRef = collection(db, `/artifacts/${appId}/public/data/reports`);
            const q = query(reportsRef, where('resolved', '==', false));
            const snapshot = await getDocs(q);
            const reportsListDiv = document.getElementById('admin-reports-list');
            reportsListDiv.innerHTML = '';
            document.getElementById('reports-badge').textContent = snapshot.size;
            document.getElementById('reports-badge').classList.toggle('hidden', snapshot.empty);

            if (snapshot.empty) {
                reportsListDiv.innerHTML = '<p>No active reports.</p>';
                return;
            }

            for (const reportDoc of snapshot.docs) {
                const report = reportDoc.data();
                const reporter = await fetchUserProfile(report.reporterId);
                const reported = await fetchUserProfile(report.reportedId);
                const reportDiv = document.createElement('div');
                reportDiv.className = 'p-3 rounded-lg bg-slate-100 dark:bg-slate-700 space-y-2';
                reportDiv.innerHTML = `
                    <p class="text-sm"><strong>${reporter.username}</strong> reported <strong>${reported.username}</strong></p>
                    <p class="text-sm italic p-2 bg-slate-200 dark:bg-slate-600 rounded">"${report.messageText}"</p>
                    <div class="flex justify-end gap-2">
                        <button data-action="resolve-report" data-report-id="${reportDoc.id}" class="text-xs bg-green-500 text-white px-2 py-1 rounded-md hover:bg-green-600">Mark as Resolved</button>
                    </div>
                `;
                reportsListDiv.appendChild(reportDiv);
            }
        }

        async function renderAdminUserList(searchTerm = '') { 
            const userListDiv = document.getElementById('admin-user-list');
            userListDiv.innerHTML = '<p>Loading users...</p>';
            
            const usersRef = collection(db, `/artifacts/${appId}/public/data/users`);
            const snapshot = await getDocs(usersRef);
            allUsersForAdmin = [];
            snapshot.forEach(doc => allUsersForAdmin.push({ uid: doc.id, ...doc.data() }));

            userListDiv.innerHTML = '';
            const filteredUsers = allUsersForAdmin.filter(user => user.username.toLowerCase().includes(searchTerm.toLowerCase()));

            if (filteredUsers.length === 0) {
                userListDiv.innerHTML = '<p>No users found.</p>';
                return;
            }

            filteredUsers.forEach(user => {
                const uid = user.uid;
                let status = '<span class="text-xs font-medium bg-green-100 text-green-800 px-2 py-1 rounded-full">Active</span>';
                let suspendButton = `<button data-admin-action="suspend-user" data-uid="${uid}" class="text-xs bg-red-500 text-white px-2 py-1 rounded-md hover:bg-red-600">Suspend</button>`;

                if (user.suspended === true) {
                    status = '<span class="text-xs font-medium bg-red-100 text-red-800 px-2 py-1 rounded-full">Suspended</span>';
                    suspendButton = `<button data-admin-action="unban" data-uid="${uid}" class="text-xs bg-gray-500 text-white px-2 py-1 rounded-md hover:bg-gray-600">Unsuspend</button>`;
                } else if (user.suspended && user.suspended.toDate) {
                    const suspensionEnd = user.suspended.toDate();
                    if (new Date() < suspensionEnd) {
                        const minutesLeft = Math.ceil((suspensionEnd - new Date()) / (1000 * 60));
                        status = `<span class="text-xs font-medium bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full">Timeout (~${minutesLeft}m)</span>`;
                        suspendButton = `<button data-admin-action="unban" data-uid="${uid}" class="text-xs bg-gray-500 text-white px-2 py-1 rounded-md hover:bg-gray-600">Unsuspend</button>`;
                    }
                }

                if (user.muted) {
                    status += '<span class="ml-1 text-xs font-medium bg-gray-200 text-gray-800 px-2 py-1 rounded-full">Muted</span>';
                }
                
                let muteButton = `<button data-admin-action="toggle-mute" data-uid="${uid}" class="text-xs bg-orange-500 text-white px-2 py-1 rounded-md hover:bg-orange-600">Mute</button>`;
                if (user.muted) {
                    muteButton = `<button data-admin-action="toggle-mute" data-uid="${uid}" class="text-xs bg-gray-500 text-white px-2 py-1 rounded-md hover:bg-gray-600">Unmute</button>`;
                }
                
                if (uid === currentUser.uid || (user.isAdmin && !adminEmails.includes(currentUser.email))) { // Super admin can edit other admins
                    suspendButton = '';
                    muteButton = '';
                }

                const userDiv = document.createElement('div');
                userDiv.className = 'p-2 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-between';
                userDiv.innerHTML = `
                    <div class="flex items-center gap-3">
                        <img src="${user.avatarUrl}" class="w-8 h-8 rounded-full object-cover">
                        <div>
                            <p class="text-sm font-medium text-slate-800 dark:text-slate-200">${user.username}</p>
                            <p class="text-xs text-slate-500">${user.isAdmin ? 'Admin' : 'User'}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap justify-end">
                        ${status}
                        <button data-admin-action="edit-user" data-uid="${uid}" class="text-xs bg-blue-500 text-white px-2 py-1 rounded-md hover:bg-blue-600">Edit</button>
                        ${muteButton}
                        ${suspendButton}
                    </div>
                `;
                userListDiv.appendChild(userDiv);
            });
        }
        function openAdminEditUserModal(uid) {
             const user = allUsersForAdmin.find(u => u.uid === uid);
            if (!user) return;
            document.getElementById('admin-edit-uid').value = uid;
            document.getElementById('admin-edit-username').value = user.username;
            document.getElementById('admin-edit-isadmin-toggle').checked = user.isAdmin;
            document.getElementById('admin-edit-user-modal').classList.remove('hidden');
        }
        function openAdminSuspendModal(uid) {
            document.getElementById('admin-suspend-uid').value = uid;
            document.getElementById('admin-suspend-user-modal').classList.remove('hidden');
        }
        async function updatePresence() { if(currentUser) await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid), { lastSeen: serverTimestamp() }); }
        function setupNotificationsListener() { const q = query(collection(db, `/artifacts/${appId}/public/data/users/${currentUser.uid}/notifications`)); notificationsUnsubscribe = onSnapshot(q, async (snapshot) => { const notifications = []; const userIds = new Set(); snapshot.forEach(doc => { const data = doc.data(); notifications.push({ id: doc.id, ...data }); if (data.from && !usersCache[data.from]) userIds.add(data.from); }); await Promise.all(Array.from(userIds).map(uid => fetchUserProfile(uid))); renderNotifications(notifications); }); }
        async function renderNotifications(notifications) { const unreadCount = notifications.length; document.getElementById('notification-badge').textContent = unreadCount; document.getElementById('notification-badge').classList.toggle('hidden', unreadCount === 0); const inboxContent = document.getElementById('inbox-content'); inboxContent.innerHTML = ''; if (notifications.length === 0) { inboxContent.innerHTML = '<p class="text-center text-sm text-slate-500 p-4">No new notifications.</p>'; return; } notifications.forEach(n => { if (n.type === 'friend_request') { const sender = usersCache[n.from]; if (!sender) return; const div = document.createElement('div'); div.className = 'p-2 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-between'; div.innerHTML = `<div class="flex items-center gap-3"><img src="${sender.avatarUrl}" class="w-8 h-8 rounded-full object-cover"><p class="text-sm font-medium text-slate-800 dark:text-slate-200">${sender.username} sent you a friend request.</p></div><div class="flex gap-2"><button data-sender-id="${n.from}" data-notification-id="${n.id}" class="accept-friend-request bg-green-500 text-white px-2 py-1 text-xs rounded-md hover:bg-green-600">Accept</button><button data-notification-id="${n.id}" class="decline-friend-request bg-red-500 text-white px-2 py-1 text-xs rounded-md hover:bg-red-600">Decline</button></div>`; inboxContent.appendChild(div); } }); }
        function setupUnreadChatsListener() { const privateChatsRef = collection(db, `/artifacts/${appId}/public/data/privateChats`); const q = query(privateChatsRef, where('members', 'array-contains', currentUser.uid)); unreadChatsUnsubscribe = onSnapshot(q, async (snapshot) => { for (const chatDoc of snapshot.docs) { const messagesRef = collection(chatDoc.ref, 'messages'); const latestMessageQuery = query(messagesRef, orderBy('timestamp', 'desc'), limit(1)); const messageSnapshot = await getDocs(latestMessageQuery); if (!messageSnapshot.empty) { const latestMessage = messageSnapshot.docs[0].data(); const lastReadTimestamp = currentUserProfile.privateChatStatus?.[chatDoc.id]?.lastRead; if (!lastReadTimestamp || (latestMessage.timestamp && latestMessage.timestamp.toMillis() > lastReadTimestamp.toMillis())) { if (latestMessage.userId !== currentUser.uid) unreadChats.add(chatDoc.id); } else { unreadChats.delete(chatDoc.id); } } } renderChatsList(); }); }
        async function sendFriendRequest(targetId) { const btn = document.getElementById('friend-request-button'); if (!targetId || targetId === currentUser.uid) return; btn.disabled = true; btn.textContent = 'Request Sent'; await setDoc(doc(collection(db, `/artifacts/${appId}/public/data/users/${targetId}/notifications`)), { type: 'friend_request', from: currentUser.uid, timestamp: serverTimestamp() }); }
        async function acceptFriendRequest(senderId, notificationId) { const batch = writeBatch(db); const currentUserRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid); batch.update(currentUserRef, { friends: arrayUnion(senderId) }); const senderRef = doc(db, `/artifacts/${appId}/public/data/users`, senderId); batch.update(senderRef, { friends: arrayUnion(currentUser.uid) }); const notifRef = doc(db, `/artifacts/${appId}/public/data/users/${currentUser.uid}/notifications`, notificationId); batch.delete(notifRef); await batch.commit(); await fetchUserProfile(currentUser.uid, true); await fetchUserProfile(senderId, true); renderChatsList(); }
        async function declineFriendRequest(notificationId) { await deleteDoc(doc(db, `/artifacts/${appId}/public/data/users/${currentUser.uid}/notifications`, notificationId)); }
        async function handleSignUp(email, password) { try { await createUserWithEmailAndPassword(auth, email, password); hideAuthError(); } catch (error) { showAuthError(error.message); } }
        async function handleLogin(email, password) { try { await signInWithEmailAndPassword(auth, email, password); hideAuthError(); } catch (error) { showAuthError(error.message); } }
        async function handleGoogleSignIn() { try { await signInWithPopup(auth, new GoogleAuthProvider()); hideAuthError(); } catch (error) { showAuthError(error.message); } }
        async function fetchUserProfile(uid, forceRefresh = false) { if (usersCache[uid] && !forceRefresh) return usersCache[uid]; try { const userRef = doc(db, `/artifacts/${appId}/public/data/users`, uid); const userSnap = await getDoc(userRef); if (userSnap.exists()) { usersCache[uid] = userSnap.data(); return usersCache[uid]; } return null; } catch (error) { console.error("Fetch profile error:", error); return null; } }
        
        async function blockUser(userId) { await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid), { blocked: arrayUnion(userId), friends: arrayRemove(userId) }); await fetchUserProfile(currentUser.uid, true); currentUserProfile = usersCache[currentUser.uid]; renderChatsList(); document.getElementById('user-profile-modal').classList.add('hidden'); switchToChat('public', 'Public Chat', 'public'); }
        async function unblockUser(userId) { await updateDoc(doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid), { blocked: arrayRemove(userId) }); await fetchUserProfile(currentUser.uid, true); currentUserProfile = usersCache[currentUser.uid]; document.getElementById('user-profile-modal').classList.add('hidden'); switchToChat('public', 'Public Chat', 'public'); }
        
        function showAuthUI() { loadingSpinner.style.display = 'none'; authContainer.classList.remove('hidden'); mainAppContainer.classList.add('hidden'); }
        function showChatUI() { loadingSpinner.style.display = 'none'; authContainer.classList.add('hidden'); mainAppContainer.classList.remove('hidden'); }
        function showMaintenanceScreen() { loadingSpinner.style.display = 'none'; authContainer.classList.add('hidden'); mainAppContainer.classList.add('hidden'); maintenanceModal.classList.remove('hidden'); }
        function showAuthError(msg) { document.getElementById('auth-error-message').textContent = msg; document.getElementById('auth-error').classList.remove('hidden'); }
        function hideAuthError() { document.getElementById('auth-error').classList.add('hidden'); }
        
        function applyTheme(theme) { localStorage.setItem('theme', theme); if (theme === 'dark') { document.documentElement.classList.add('dark'); if (document.getElementById('dark-mode-toggle')) document.getElementById('dark-mode-toggle').checked = true; } else { document.documentElement.classList.remove('dark'); if (document.getElementById('dark-mode-toggle')) document.getElementById('dark-mode-toggle').checked = false; } }
        
        async function openUserProfile(userId) { if (userId === currentUser.uid) { document.getElementById('settings-button').click(); return; } profileModalTargetId = userId; const profile = await fetchUserProfile(userId); if (!profile) return; document.getElementById('profile-modal-avatar').src = profile.avatarUrl || `https://placehold.co/80x80/e2e8f0/475569?text=${profile.username.charAt(0).toUpperCase()}`; document.getElementById('profile-modal-username').textContent = profile.username; document.getElementById('profile-modal-status').textContent = profile.status || 'No status set.'; const isOnline = profile.prefs?.showOnline && profile.lastSeen && (new Date() - profile.lastSeen.toDate()) < 5 * 60 * 1000; document.getElementById('profile-modal-online-status').classList.toggle('hidden', !isOnline); const isBlocked = currentUserProfile.blocked?.includes(userId); document.getElementById('block-user-button').classList.toggle('hidden', isBlocked); document.getElementById('unblock-user-button').classList.toggle('hidden', !isBlocked); document.getElementById('user-profile-modal').classList.remove('hidden'); }
        function showConfirmationModal(title, msg, onConfirm) { document.getElementById('confirmation-title').textContent = title; document.getElementById('confirmation-message').textContent = msg; confirmationCallback = onConfirm; document.getElementById('confirmation-modal').classList.remove('hidden'); }
        
        async function downloadHtmlAsZip(filename = "bazinga-chat-source.zip") {
            if (typeof JSZip === 'undefined') {
                alert("Download library is not available. Please try again.");
                return;
            }
            const htmlContent = document.documentElement.outerHTML;
            try {
                const zip = new JSZip();
                zip.file("index.html", htmlContent);
                const content = await zip.generateAsync({ type: "blob" });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            } catch (error) {
                 console.error("Download failed:", error);
                alert("Could not download the source file.");
            }
        }

        function playNotificationSound() { if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)(); const oscillator = audioContext.createOscillator(); const gainNode = audioContext.createGain(); oscillator.connect(gainNode); gainNode.connect(audioContext.destination); oscillator.type = 'sine'; oscillator.frequency.setValueAtTime(800, audioContext.currentTime); gainNode.gain.setValueAtTime(0.1, audioContext.currentTime); gainNode.gain.exponentialRampToValueAtTime(0.00001, audioContext.currentTime + 0.5); oscillator.start(audioContext.currentTime); oscillator.stop(audioContext.currentTime + 0.5); }
        function downloadUserData() { const dataStr = JSON.stringify(currentUserProfile, null, 2); const blob = new Blob([dataStr], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = "my_bazinga_chat_data.json"; a.click(); URL.revokeObjectURL(url); }
        async function clearPublicChat() { const messagesRef = collection(db, `/artifacts/${appId}/public/data/messages`); const q = query(messagesRef); const querySnapshot = await getDocs(q); const batch = writeBatch(db); querySnapshot.forEach((doc) => { batch.delete(doc.ref); }); await batch.commit(); document.getElementById('confirmation-modal').classList.add('hidden'); alert('Public chat history has been cleared.'); }

        async function switchToChat(chatId, chatName, type = 'private') {
            currentChatId = chatId;
            if (messagesUnsubscribe) messagesUnsubscribe();

            document.querySelectorAll('#chats-list-container > div').forEach(el => el.classList.remove('bg-indigo-100', 'dark:bg-indigo-500/20'));
            const activeEl = document.querySelector(`[data-chat-id="${chatId}"]`);
            if (activeEl) activeEl.classList.add('bg-indigo-100', 'dark:bg-indigo-500/20');

            document.getElementById('chat-title').textContent = chatName;
            if (type === 'public') {
                document.getElementById('chat-subtitle').textContent = `Welcome, ${currentUserProfile?.username || ''}!`;
            } else if (type === 'group') {
                const group = await fetchGroupInfo(chatId.replace('group_', ''));
                document.getElementById('chat-subtitle').textContent = `${group.members.length} members`;
            } else { // private
                document.getElementById('chat-subtitle').textContent = 'A private conversation.';
                const userRef = doc(db, `/artifacts/${appId}/public/data/users`, currentUser.uid);
                await updateDoc(userRef, { [`privateChatStatus.${chatId}.lastRead`]: serverTimestamp() });
                unreadChats.delete(chatId);
                renderChatsList();
            }
            setupMessageListener();
        }

        function setupMessageListener() {
            let path;
            if (currentChatId.startsWith('group_')) {
                path = `/artifacts/${appId}/public/data/groups/${currentChatId.replace('group_', '')}/messages`;
            } else if (currentChatId === 'public') {
                path = `/artifacts/${appId}/public/data/messages`;
            } else {
                path = `/artifacts/${appId}/public/data/privateChats/${currentChatId}/messages`;
            }
            
            messagesUnsubscribe = onSnapshot(query(collection(db, path)), async (snapshot) => {
                const messages = [];
                const userIds = new Set();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (!currentUserProfile.blocked?.includes(data.userId)) {
                        messages.push({ id: doc.id, ...data });
                        if (data.userId && !usersCache[data.userId]) userIds.add(data.userId);
                    }
                });
                if (document.hidden && messages.length > 0 && messages[messages.length - 1].userId !== currentUser.uid && currentUserProfile.prefs?.soundEnabled && currentChatId !== 'public') {
                    playNotificationSound();
                }
                await Promise.all(Array.from(userIds).map(uid => fetchUserProfile(uid)));
                messages.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
                renderMessages(messages);
            }, (e) => console.error("Message listener error:", e));
        }

        async function sendMessage(text) {
            if (!text.trim() || !currentUser || currentUserProfile.muted || (currentChatId === 'public' && systemConfig.chatLocked && !currentUserProfile.isAdmin)) return;
            
            let processedText = text;
            if (systemConfig.bannedWords?.length > 0) {
                const regex = new RegExp(systemConfig.bannedWords.join('|'), 'gi');
                processedText = text.replace(regex, match => '*'.repeat(match.length));
            }
            
            let path;
            if (currentChatId.startsWith('group_')) {
                path = `/artifacts/${appId}/public/data/groups/${currentChatId.replace('group_', '')}/messages`;
            } else if (currentChatId === 'public') {
                path = `/artifacts/${appId}/public/data/messages`;
            } else {
                path = `/artifacts/${appId}/public/data/privateChats/${currentChatId}/messages`;
                const chatDocRef = doc(db, `/artifacts/${appId}/public/data/privateChats`, currentChatId);
                await setDoc(chatDocRef, { members: [currentUser.uid, profileModalTargetId] }, { merge: true });
            }

            try {
                await addDoc(collection(db, path), { text: formatMessageText(processedText, true), userId: currentUser.uid, timestamp: serverTimestamp() });
            } catch (error) { console.error("Send message error:", error); }
        }
        
        function formatMessageText(text, sending = false) {
            if (!text) return '';
            let processedText = text;
            if (sending) {
                processedText = text.replace(/:(\w+):/g, (match, emojiName) => emojiMap[emojiName.toLowerCase()] || match);
            }
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const sanitizedText = processedText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
            return sanitizedText.replace(urlRegex, url => `<a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-300 hover:underline">${url}</a>`);
        }

        function renderMessages(messages) {
            document.getElementById('messages-container').innerHTML = ''; 
            messages.forEach(msg => { 
                const isMe = msg.userId === currentUser.uid; 
                const profile = usersCache[msg.userId]; 
                if (!profile) return; 
                
                const messageId = msg.id;
                const chatId = currentChatId;

                if (msg.type === 'broadcast') {
                    const broadcastDiv = document.createElement('div');
                    broadcastDiv.className = 'my-4 p-3 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg flex items-center gap-3 text-sm border border-indigo-200 dark:border-indigo-800';
                    broadcastDiv.innerHTML = `<span class="text-indigo-500"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8a6 6 0 0 0-12 0"></path><path d="M10 14a2 2 0 1 1 4 0"></path><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg></span><p class="text-indigo-800 dark:text-indigo-200"><span class="font-semibold">${profile.username} (Admin):</span> ${formatMessageText(msg.text)}</p>`;
                    document.getElementById('messages-container').appendChild(broadcastDiv);
                    return;
                }

                const wrapper = document.createElement('div'); 
                wrapper.className = `flex gap-3 mb-4 group ${isMe ? 'flex-row-reverse' : 'flex-row'}`; 
                
                const avatar = document.createElement('img'); 
                avatar.className = 'w-10 h-10 rounded-full object-cover cursor-pointer mt-auto'; 
                avatar.src = profile.avatarUrl || `https://placehold.co/40x40/e2e8f0/475569?text=${profile.username.charAt(0).toUpperCase()}`; 
                avatar.onclick = () => openUserProfile(msg.userId); 
                const content = document.createElement('div'); 
                content.className = `flex flex-col ${isMe ? 'items-end' : 'items-start'}`; 
                const name = document.createElement('p'); 
                name.textContent = isMe ? 'You' : profile.username; 
                name.className = `text-xs text-slate-500 dark:text-slate-400 mb-1 mx-3`; 
                const bubble = document.createElement('div'); 
                bubble.className = `relative max-w-xs md:max-w-md p-3 rounded-2xl shadow ${isMe ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white dark:bg-slate-700 text-slate-800 dark:text-white rounded-bl-none'}`; 
                const text = document.createElement('p'); 
                text.innerHTML = formatMessageText(msg.text); 
                text.className = 'text-sm break-words'; 
                
                bubble.appendChild(text); 
                content.appendChild(name); 
                content.appendChild(bubble); 
                wrapper.appendChild(avatar); 
                wrapper.appendChild(content); 

                // Add admin/report controls
                const controls = document.createElement('div');
                controls.className = `absolute -top-4 ${isMe ? 'left-0' : 'right-0'} hidden group-hover:flex items-center gap-1 bg-slate-200 dark:bg-slate-600 p-1 rounded-full shadow`;
                
                if (!isMe) {
                    controls.innerHTML += `<button title="Report" data-action="report-message" data-chat-id="${chatId}" data-msg-id="${messageId}" data-sender-id="${msg.userId}" class="p-1 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path><line x1="4" y1="22" x2="4" y2="15"></line></svg></button>`;
                }
                if (currentUserProfile.isAdmin) {
                    controls.innerHTML += `<button title="Delete" data-action="delete-message" data-chat-id="${chatId}" data-msg-id="${messageId}" class="p-1 hover:bg-slate-300 dark:hover:bg-slate-500 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg></button>`;
                }
                if(controls.innerHTML !== '') bubble.appendChild(controls);

                document.getElementById('messages-container').appendChild(wrapper);
            });
            document.getElementById('messages-container').scrollTop = document.getElementById('messages-container').scrollHeight;
        }

        async function renderChatsList() {
            const container = document.getElementById('chats-list-container');
            container.innerHTML = '';

            // Public Chat
            const publicDiv = document.createElement('div');
            publicDiv.className = 'flex items-center justify-between gap-3 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 cursor-pointer';
            publicDiv.dataset.chatId = 'public';
            publicDiv.onclick = () => switchToChat('public', 'Public Chat', 'public');
            publicDiv.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12h.007c.004-.33.04-.658.11-0.975 M4.268 18.975A9.954 9.954 0 0 1 12 14c1.67 0 3.243.408 4.61 1.134M16 18l-3.5-2-3.5 2" /><path d="m14.5 7.5-5 5" /><path d="m9.5 7.5 5 5" /></svg></div><p class="font-medium text-slate-700 dark:text-slate-200">Public Chat</p></div>`;
            container.appendChild(publicDiv);

            // Group Chats
            for (const groupId of (currentUserProfile.groups || [])) {
                const group = await fetchGroupInfo(groupId);
                if (!group) continue;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between gap-3 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 cursor-pointer';
                div.dataset.chatId = `group_${groupId}`;
                div.onclick = () => switchToChat(`group_${groupId}`, group.name, 'group');
                div.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div><p class="font-medium text-slate-700 dark:text-slate-200">${group.name}</p></div>`;
                container.appendChild(div);
            }

            // Friend (Private) Chats
            const friends = currentUserProfile.friends || [];
            friends.sort(); // Sort to maintain a consistent order
            for (const friendId of friends) {
                const profile = await fetchUserProfile(friendId);
                if (!profile) continue;
                const chatId = [currentUser.uid, friendId].sort().join('_');
                const hasUnread = unreadChats.has(chatId);
                const isOnline = profile.prefs?.showOnline && profile.lastSeen && (new Date() - profile.lastSeen.toDate()) < 5 * 60 * 1000;
                const div = document.createElement('div');
                div.className = 'flex items-center justify-between gap-3 p-2 rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 cursor-pointer';
                div.dataset.chatId = chatId;
                div.onclick = () => startPrivateChat(friendId, profile.username);
                div.innerHTML = `<div class="flex items-center gap-3"><div class="relative"><img src="${profile.avatarUrl || `https://placehold.co/40x40/e2e8f0/475569?text=${(profile.username || 'U').charAt(0).toUpperCase()}`}" class="w-8 h-8 rounded-full object-cover">${isOnline ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-green-500 ring-2 ring-white dark:ring-slate-800"></span>' : ''}</div><p class="font-medium text-slate-700 dark:text-slate-200">${profile.username}</p></div> ${hasUnread ? '<span class="w-2.5 h-2.5 bg-red-500 rounded-full"></span>' : ''}`;
                container.appendChild(div);
            }
        }

        async function fetchGroupInfo(groupId) {
            if (usersCache[groupId]) return usersCache[groupId];
            const groupRef = doc(db, `/artifacts/${appId}/public/data/groups`, groupId);
            const docSnap = await getDoc(groupRef);
            if (docSnap.exists()) {
                usersCache[groupId] = { id: docSnap.id, ...docSnap.data() };
                return usersCache[groupId];
            }
            return null;
        }

        async function openCreateGroupModal() {
            const friendsListDiv = document.getElementById('group-friends-list');
            friendsListDiv.innerHTML = '';
            const friendUids = currentUserProfile.friends || [];
            if (friendUids.length === 0) {
                friendsListDiv.innerHTML = '<p class="text-sm text-slate-500 text-center">You need friends to create a group.</p>';
            } else {
                for (const friendId of friendUids) {
                    const profile = await fetchUserProfile(friendId);
                    if (profile) {
                         friendsListDiv.innerHTML += `<label class="flex items-center gap-3 p-2 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer"><input type="checkbox" value="${friendId}" class="rounded border-slate-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-offset-0 focus:ring-indigo-200 focus:ring-opacity-50"><span>${profile.username}</span></label>`;
                    }
                }
            }
            document.getElementById('create-group-modal').classList.remove('hidden');
        }
        
        async function deleteMessage(chatId, msgId) {
            let path;
            if (chatId.startsWith('group_')) path = `/artifacts/${appId}/public/data/groups/${chatId.replace('group_', '')}/messages/${msgId}`;
            else if (chatId === 'public') path = `/artifacts/${appId}/public/data/messages/${msgId}`;
            else path = `/artifacts/${appId}/public/data/privateChats/${chatId}/messages/${msgId}`;
            await deleteDoc(doc(db, path));
        }

        async function reportMessage(chatId, msgId, senderId) {
            let messageText = '';
            let path;
            if (chatId.startsWith('group_')) path = `/artifacts/${appId}/public/data/groups/${chatId.replace('group_', '')}/messages/${msgId}`;
            else if (chatId === 'public') path = `/artifacts/${appId}/public/data/messages/${msgId}`;
            else path = `/artifacts/${appId}/public/data/privateChats/${chatId}/messages/${msgId}`;
            
            const msgDoc = await getDoc(doc(db, path));
            if(msgDoc.exists()) messageText = msgDoc.data().text;

            await addDoc(collection(db, `/artifacts/${appId}/public/data/reports`), {
                reporterId: currentUser.uid,
                reportedId: senderId,
                messageText: messageText,
                chatId: chatId,
                messageId: msgId,
                timestamp: serverTimestamp(),
                resolved: false
            });
            alert('Message reported. Thank you.');
        }
        function startPrivateChat(friendId, friendUsername) { const chatId = [currentUser.uid, friendId].sort().join('_'); profileModalTargetId = friendId; switchToChat(chatId, friendUsername); }

        main();
    </script>
</body>
</html>

